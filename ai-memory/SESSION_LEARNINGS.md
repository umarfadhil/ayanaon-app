# Session Learnings
Append-only log of durable discoveries.
Max 10 lines per task.

## SEO & Canonical URLs (2026-02-14)

### Issue: Google Search Console "Alternative page with proper canonical tag"
- **Root cause**: Canonical URL mismatch between hardcoded meta tag and actual site URL
- Static `index.html` had canonical URL: `https://ayanaon.app/`
- Actual site accessed via: `https://www.ayanaon.app/`
- Query parameters like `?pin=<id>` inherited the wrong canonical, creating duplicates

### Fix
- Updated canonical and og:url in `public/index.html` to match actual domain with www subdomain
- Ensures all homepage variations (`/`, `/?pin=<id>`, etc.) point to same canonical URL
- Server-rendered pages (`/pin/:id`, `/kategori/*`) already generate correct canonicals dynamically

### Learning
- **Always align canonical URLs with actual site domain** (including www vs non-www)
- Static HTML files need manual canonical tag updates
- Query parameters should resolve to same canonical as base URL
- Server-rendered pages use dynamic canonical generation (already correct)

## Sitemap & Redirects (2026-02-14)

### Issue: Google Search Console "Page with redirect"
- **Root cause 1**: Sitemap included legacy redirect URLs `/kategori/:category/:city` that redirect to `/kategori/:category/:province/:city`
- **Root cause 2**: HTTP and non-www URLs not properly redirected at infrastructure level
- Legacy redirect handler exists at line 5481 (`handleCategoryLegacyRedirect`) for backward compatibility
- Sitemap generator (`buildLandingEntriesFromPins`) was including both formats

### Fix
- Modified sitemap generation to skip entries without province (line 1483-1485: early return if `!provinceSlug`)
- Added HTTPS force redirects in `netlify.toml` for `http://ayanaon.app/*` and `http://www.ayanaon.app/*`
- Added non-www to www redirect in `netlify.toml` for `https://ayanaon.app/*`
- All redirects use 301 status with `force = true` for proper SEO signal

### Learning
- **Sitemap should only include final URLs, never intermediate redirect URLs**
- Use `force = true` in Netlify redirects to ensure they take precedence
- Order matters: HTTPS redirects before non-www redirects in config
- Legacy redirect handlers are fine for backward compatibility, just exclude from sitemap

## Duplicate Content - Mass Promotions (2026-02-14)

### Issue: Google Search Console "Duplicate, Google chose different canonical than user"
- **Root cause**: Mass promotions create multiple pins with identical title/description but different locations
- Each pin has unique canonical URL pointing to itself (`/pin/:id`), but Google sees identical content as duplicates
- Google ignores the specified canonical and chooses its own, causing indexing issues
- Mass promotions feature allows creating multiple pins at once (e.g., brand promotion across multiple locations)

### Fix
- Added location (city) to page title: `${title} | ${city} | ${siteTitle}` (line 1914-1916)
- Added location suffix to meta description: `${description} di ${city}, ${province}` (line 1908-1910)
- Makes each pin page unique even with identical promotion content
- Location-specific titles/descriptions signal to Google that pages serve different geographic audiences

### Learning
- **For duplicate content with location variance, include location in title and description**
- Page title should be: `Content | Location | Site` for geo-specific duplicates
- Meta descriptions should mention location to differentiate similar content
- Each page maintains its own canonical URL but content is unique enough to avoid duplicate detection

## Google Search Snippets & Sitelinks (2026-02-14)

### Issue: Google showing wrong meta description and uncontrolled sitelinks
- **Problem 1**: Searching "ayanaon.app" showed UI text instead of meta description tag value
- Google scraped: "Tap peta untuk menjatuhkan pin... Install App... Update Tersedia" from page body
- **Problem 2**: Sitelinks auto-generated by Google without control over which pages appear

### Fix
- Added JSON-LD WebSite schema with proper description and SearchAction (line 34-47)
- Added JSON-LD ItemList schema for 8 priority category sitelinks (line 48-102)
- Added `data-nosnippet` attribute to UI elements (navigation, install buttons, instructions) to exclude from snippets
- Added hidden SEO-optimized content block with h1 and description paragraph for crawlers (line 105-108)

### Learning
- **Use JSON-LD structured data to control search appearance** - WebSite schema for site info, ItemList for sitelinks
- **Use `data-nosnippet` attribute** to prevent specific HTML elements from appearing in search snippets
- Hidden accessibility content (off-screen but semantic) helps Google understand page purpose
- Meta description alone isn't enough - structured data + hidden semantic content reinforces it
- Sitelinks require ItemList schema with proper URLs and names for each preferred link

## Mass Promotion Optimization (2026-02-16)

### Issue: Mass promo pins burden initial load and duplicate image storage
- All pins loaded on page load, including mass promos that may be irrelevant to user's location
- Each mass promo pin stored its own copy of base64 images, wasting MongoDB storage

### Fix
- **Flagging**: Mass promo pins now have `massPromotion: true` and `massPromotionGroupId` fields
- **Shared images**: Only first pin in a group stores images; subsequent pins use `sharedImagesFromGroup` reference, resolved at read time via `resolveSharedImages()`
- **Location-gated loading**: `GET /pins` excludes `massPromotion: true`; new `GET /pins/nearby-promos?lat=X&lng=Y` returns mass promos within 10km using Haversine bounding-box + exact distance filter
- **Frontend**: `fetchNearbyPromos()` called when `userLocation` becomes available (both `getCurrentPosition` and `watchPosition` callbacks); uses `nearbyPromosLoaded` flag to avoid duplicate fetches

### Learning
- **Use a groupId pattern for bulk-created resources** to enable shared references (images, metadata)
- **Haversine bounding-box pre-filter** (lat/lng ± delta) before exact distance check is efficient without a 2dsphere index
- **Location-gated content** should be loaded separately from main data to avoid penalizing users without location

## Mass Promo Pins Disappearing Bug (2026-02-16)

### Issue: Mass promo pins load then vanish after regular pins sync
- Console log sequence: "Nearby promos loaded {count: 2}" → "Pins synchronized {count: 3358}"
- Promo pins visible briefly, then removed from map

### Root Cause
- `fetchPins()` sync loop (line ~8231) removes all markers not in `seenIds` set
- `seenIds` only contains IDs from `/api/pins` response, which **excludes** mass promo pins (`massPromotion: { $ne: true }`)
- Mass promo pins added by `fetchNearbyPromos()` were in `pinMarkersById` but not in `seenIds`, so sync deleted them

### Fix
- Added guard in sync loop: skip removal if `marker.pin.massPromotion` is truthy
- `pinMarkersById.forEach` now preserves mass promo markers during regular pin sync

### Learning
- **When multiple endpoints contribute to a shared marker map, the sync/reconciliation logic must account for all sources**
- Markers from secondary endpoints need a distinguishing flag to survive primary endpoint sync cycles

## Category Landing Page Filters (2026-02-16)

### Issue: Province/city filters not auto-applied from URL parameters
- URL `/kategori/promo-diskon-makanan-minuman/jawa-barat/kota-bandung` showed all pins instead of filtering by province and city
- Server-rendered HTML passed `provinceSlug` and `regionSlug` (city) to `buildCategoryLandingHtml()` but not to frontend script
- Filter dropdowns rendered with correct options but no selected values
- Initial search ran without province/city filters

### Root Cause
- Script only received `window.__regionTree` and `window.__categorySlug` (line 3820)
- No initialization code to set filter values from URL parameters
- `doSearch()` only triggered after geolocation, ignoring URL-based filters

### Fix
- Added `window.__provinceSlug` and `window.__regionSlug` to script globals (line 3820)
- Initialize `provinceSelect.value = initialProvinceSlug` on page load
- Call `populateCities()` to load city options for selected province
- Set `citySelect.value = initialRegionSlug` after populating cities
- Trigger `doSearch(1)` even if geolocation fails/unavailable when URL filters present

### Learning
- **Server-rendered pages with client-side filtering must pass URL parameters to frontend**
- Initialize filter UI state from URL on page load before any search triggers
- Don't rely solely on async geolocation for initial search when filters are in URL
